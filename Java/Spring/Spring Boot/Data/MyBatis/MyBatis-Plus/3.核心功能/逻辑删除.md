#### 3.8 逻辑删除

逻辑删除是指在删除数据时，并不真正从数据库中物理删除，而是通过一个标记字段 (如 `is_deleted`, `deleted_flag`) 来表示该数据已“删除”。MP 提供了对逻辑删除的便捷支持。

**配置与使用：**

1.  **在数据库表中添加逻辑删除标记字段** (例如 `deleted`，类型通常是 `INT`, `TINYINT`, `BOOLEAN` 或 `VARCHAR`)。

2.  **在实体类中添加对应的属性，并使用 `@TableLogic` 注解：**
    ```java
    import com.baomidou.mybatisplus.annotation.TableLogic;
    import com.baomidou.mybatisplus.annotation.TableField;

    public class Article {
        @TableId
        private Long id;
        private String title;

        @TableLogic // 标记这是逻辑删除字段
        // (可选) value 和 delval 指定逻辑未删除值和逻辑已删除值，如果与全局配置不同
        // @TableLogic(value = "0", delval = "1")
        @TableField("is_deleted") // (可选) 如果数据库列名与属性名不一致
        private Integer deleted; // 或者 Boolean, String 等
    }
    ```

3.  **全局配置逻辑删除的默认值 (可选，但推荐)**:
    在 `application.yml` 中：
    ```yaml
    mybatis-plus:
      global-config:
        db-config:
          logic-delete-field: deleted # 全局指定逻辑删除的实体属性名 (如果实体类中不写 @TableLogic，但有此属性名，也会生效)
          logic-delete-value: "1"   # 逻辑已删除的值 (字符串类型的值需要引号)
          logic-not-delete-value: "0" # 逻辑未删除的值
    ```
    *   如果同时有全局配置和 `@TableLogic` 注解，**注解的配置会覆盖全局配置**。
    *   如果实体类中没有 `@TableLogic` 注解，但其属性名与 `logic-delete-field` 全局配置的名称一致，MP 也会将其视为逻辑删除字段，并使用全局的 `value` 和 `delval`。

4.  **使用 MP 提供的删除方法**:
    当你调用 `deleteById`, `deleteByMap`, `deleteBatchIds`, `delete(wrapper)` (以及 `IService` 封装的 `removeXXX` 方法) 时：
    *   MP 不会执行物理 `DELETE` 语句。
    *   而是会执行一个 `UPDATE` 语句，将标记字段更新为“已删除”的值。
    *   例如：`UPDATE article SET is_deleted = 1 WHERE id = ? AND is_deleted = 0` (注意，条件中也会带上未删除的状态)。

5.  **查询时自动过滤已逻辑删除的数据**:
    当你调用 MP 提供的所有查询方法 (如 `selectById`, `selectList`, `selectPage`, `selectCount` 等) 时：
    *   MP 会自动在 `WHERE` 子句中追加条件，以排除那些已被逻辑删除的记录。
    *   例如：`SELECT ... FROM article WHERE ... AND is_deleted = 0`。

**如何查询包含逻辑删除的数据 (或只查询逻辑删除的数据)？**

*   如果你需要查询包括已逻辑删除的数据，或者专门查询已逻辑删除的数据，你需要在自定义的 Mapper XML 方法中编写 SQL，**不依赖 MP 的自动过滤**。
*   或者，可以通过 Wrapper 的 `apply` 方法临时拼接条件，但这比较 hacky。
    ```java
    // 示例：查询所有数据，包括已逻辑删除的 (不推荐，最好自定义SQL)
    // LambdaQueryWrapper<Article> wrapper = new LambdaQueryWrapper<>();
    // wrapper.apply("1=1"); // 尝试覆盖 MP 自动添加的 deleted = 0 条件，但这可能不稳定
    // List<Article> allArticles = articleMapper.selectList(wrapper);

    // 推荐方式：在 XML 中定义一个不带逻辑删除过滤的查询方法
    // <select id="selectAllIncludingDeleted" resultType="Article">
    //     SELECT * FROM article
    // </select>
    ```

**自定义逻辑删除值：**

*   **全局配置**: 通过 `global-config.db-config.logic-delete-value` 和 `logic-not-delete-value`。
*   **注解配置**: 在 `@TableLogic` 注解中使用 `value()` (未删除值) 和 `delval()` (已删除值) 属性。
    ```java
    @TableLogic(value = "NORMAL", delval = "DELETED") // 假设使用字符串类型
    private String status;
    ```