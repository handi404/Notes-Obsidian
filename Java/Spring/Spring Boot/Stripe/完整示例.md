ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŸºäº **Spring Boot** çš„ Stripe é›†æˆå®Œæ•´ç¤ºä¾‹é¡¹ç›®ç»“æ„ï¼ŒåŒ…æ‹¬å…¸å‹çš„åˆ†å±‚æ¶æ„ï¼ˆControllerã€Serviceã€é…ç½®ç±»ç­‰ï¼‰ï¼Œç”¨äºå®ç°åˆ›å»ºæ”¶è´¹ï¼ˆChargeï¼‰ã€é€€æ¬¾ï¼ˆRefundï¼‰å’Œç®¡ç†è®¢é˜…ç­‰åŠŸèƒ½ã€‚

---

## ğŸ—‚ é¡¹ç›®ç»“æ„æ¦‚è§ˆ

```
src/
â”œâ”€â”€ main/
â”‚   â””â”€â”€ java/
â”‚       â””â”€â”€ com/example/stripe/
â”‚           â”œâ”€â”€ config/
â”‚           â”‚   â””â”€â”€ StripeConfig.java
â”‚           â”œâ”€â”€ controller/
â”‚           â”‚   â””â”€â”€ PaymentController.java
â”‚           â”œâ”€â”€ dto/
â”‚           â”‚   â”œâ”€â”€ ChargeRequest.java
â”‚           â”‚   â”œâ”€â”€ RefundRequest.java
â”‚           â”‚   â””â”€â”€ SubscriptionRequest.java
â”‚           â”œâ”€â”€ service/
â”‚           â”‚   â””â”€â”€ StripeService.java
â”‚           â””â”€â”€ StripeApplication.java
â”‚
â””â”€â”€ resources/
    â””â”€â”€ application.properties
```

---

## ğŸ§¾ 1. application.properties

```properties
stripe.secret-key=sk_test_your_secret_key_here
server.port=8080
```

---

## âš™ï¸ 2. StripeConfig.java

```java
package com.example.stripe.config;

import com.stripe.Stripe;
import jakarta.annotation.PostConstruct;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

@Component
public class StripeConfig {

    @Value("${stripe.secret-key}")
    private String secretKey;

    @PostConstruct
    public void init() {
        Stripe.apiKey = secretKey;
    }
}
```

---

## ğŸ“¦ 3. DTO ç±»ï¼ˆç”¨äºæ¥æ”¶è¯·æ±‚å‚æ•°ï¼‰

### ChargeRequest.java

```java
package com.example.stripe.dto;

import lombok.Data;

@Data
public class ChargeRequest {
    private Long amount;
    private String currency;
    private String source; // å‰ç«¯ä¼ æ¥çš„ tokenï¼Œå¦‚ "tok_visa"
    private String description;
}
```

### RefundRequest.java

```java
package com.example.stripe.dto;

import lombok.Data;

@Data
public class RefundRequest {
    private String chargeId;
    private Long amount; // å¯é€‰ï¼Œnull è¡¨ç¤ºå…¨é¢é€€æ¬¾
}
```

### SubscriptionRequest.java

```java
package com.example.stripe.dto;

import lombok.Data;

@Data
public class SubscriptionRequest {
    private String customerId;
    private String priceId;
}
```

---

## ğŸ§  4. StripeService.java

```java
package com.example.stripe.service;

import com.example.stripe.dto.ChargeRequest;
import com.example.stripe.dto.RefundRequest;
import com.example.stripe.dto.SubscriptionRequest;
import com.stripe.exception.StripeException;
import com.stripe.model.*;
import com.stripe.param.*;

import org.springframework.stereotype.Service;

@Service
public class StripeService {

    public Charge createCharge(ChargeRequest request) throws StripeException {
        ChargeCreateParams params = ChargeCreateParams.builder()
            .setAmount(request.getAmount())
            .setCurrency(request.getCurrency())
            .setSource(request.getSource())
            .setDescription(request.getDescription())
            .build();

        return Charge.create(params);
    }

    public Refund createRefund(RefundRequest request) throws StripeException {
        RefundCreateParams.Builder builder = RefundCreateParams.builder()
            .setCharge(request.getChargeId());

        if (request.getAmount() != null) {
            builder.setAmount(request.getAmount());
        }

        return Refund.create(builder.build());
    }

    public Subscription createSubscription(SubscriptionRequest request) throws StripeException {
        SubscriptionCreateParams params = SubscriptionCreateParams.builder()
            .setCustomer(request.getCustomerId())
            .addItem(SubscriptionCreateParams.Item.builder()
                .setPrice(request.getPriceId())
                .build())
            .build();

        return Subscription.create(params);
    }

    public Subscription cancelSubscription(String subscriptionId) throws StripeException {
        Subscription subscription = Subscription.retrieve(subscriptionId);
        return subscription.cancel();
    }

    public PaymentMethod getPaymentMethodDetails(String paymentMethodId) throws StripeException {
        return PaymentMethod.retrieve(paymentMethodId);
    }
}
```

---

## ğŸŒ 5. PaymentController.java

```java
package com.example.stripe.controller;

import com.example.stripe.dto.ChargeRequest;
import com.example.stripe.dto.RefundRequest;
import com.example.stripe.dto.SubscriptionRequest;
import com.example.stripe.service.StripeService;
import com.stripe.exception.StripeException;
import com.stripe.model.*;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/stripe")
public class PaymentController {

    @Autowired
    private StripeService stripeService;

    @PostMapping("/charge")
    public Charge charge(@RequestBody ChargeRequest request) throws StripeException {
        return stripeService.createCharge(request);
    }

    @PostMapping("/refund")
    public Refund refund(@RequestBody RefundRequest request) throws StripeException {
        return stripeService.createRefund(request);
    }

    @PostMapping("/subscribe")
    public Subscription subscribe(@RequestBody SubscriptionRequest request) throws StripeException {
        return stripeService.createSubscription(request);
    }

    @PostMapping("/cancel-subscription/{id}")
    public Subscription cancel(@PathVariable("id") String id) throws StripeException {
        return stripeService.cancelSubscription(id);
    }

    @GetMapping("/payment-method/{id}")
    public PaymentMethod getPaymentMethod(@PathVariable("id") String id) throws StripeException {
        return stripeService.getPaymentMethodDetails(id);
    }
}
```

---

## ğŸš€ 6. å¯åŠ¨ç±» StripeApplication.java

```java
package com.example.stripe;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class StripeApplication {
    public static void main(String[] args) {
        SpringApplication.run(StripeApplication.class, args);
    }
}
```

---

## âœ… æµ‹è¯•ç¤ºä¾‹ï¼ˆä½¿ç”¨ Postmanï¼‰

1. åˆ›å»ºæ”¶è´¹ï¼š
    

```http
POST http://localhost:8080/api/stripe/charge
Content-Type: application/json

{
  "amount": 1000,
  "currency": "usd",
  "source": "tok_visa",
  "description": "æµ‹è¯•å•†å“"
}
```

2. é€€æ¬¾ï¼š
    

```http
POST http://localhost:8080/api/stripe/refund
Content-Type: application/json

{
  "chargeId": "ch_1234567890abcdef",
  "amount": 500
}
```

3. åˆ›å»ºè®¢é˜…ï¼š
    

```http
POST http://localhost:8080/api/stripe/subscribe
Content-Type: application/json

{
  "customerId": "cus_ABC123",
  "priceId": "price_1NqABCxyz"
}
```

---

## ğŸ” å®‰å…¨å»ºè®®

- æ‰€æœ‰æ¥å£å»ºè®®æ·»åŠ è®¤è¯ï¼ˆå¦‚ JWTï¼‰ã€‚
    
- ä¸è¦å°† Secret Key å†™æ­»åœ¨ä»£ç ä¸­æˆ–å…¬å¼€ç‰ˆæœ¬æ§åˆ¶ä¸­ã€‚
    
- å¯¹æ•æ„Ÿæ•°æ®ï¼ˆå¦‚ tokenã€chargeIdï¼‰åšæ ¡éªŒã€‚
    

---
