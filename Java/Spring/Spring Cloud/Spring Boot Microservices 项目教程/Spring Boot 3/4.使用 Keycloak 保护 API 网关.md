在本系列教程的第 4 部分，我们将使用 Keycloak 来保护我们的 API 网关
参考：[[5.安全性(Security)]]
## 什么是 Keycloak？

Keycloak 是一个开源的授权服务器，可以用来将我们的应用程序的认证和授权外包出去。Keycloak 支持各种认证和授权协议，如 OAuth2、OpenID Connect、SAML 等。它还提供了一些开箱即用的功能，例如单点登录（SSO）和多因素认证（MFA）。

如果你想了解更多关于 OAuth2 和 OIDC 的信息，可以参考以下文档  
[https://oauth.net/2/](https://oauth.net/2/) 和 [https://openid.net/developers/how-connect-works/](https://openid.net/developers/how-connect-works/)

## 下载 Keycloak

下载 Keycloak，我们必须在 API 网关项目中创建 docker-compose.yml 文件。

**docker-compose.yml**

```
version: '3.8'
services:
  keycloak-mysql:
    container_name: keycloak-mysql
    image: mysql:8
    volumes:
      - ./volume-data/mysql_keycloak_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: keycloak
      MYSQL_USER: keycloak
      MYSQL_PASSWORD: password
  keycloak:
    container_name: keycloak
    image: quay.io/keycloak/keycloak:24.0.1
    command: [ "start-dev", "--import-realm" ]
    environment:
      DB_VENDOR: MYSQL
      DB_ADDR: mysql
      DB_DATABASE: keycloak
      DB_USER: keycloak
      DB_PASSWORD: password
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8181:8080"
    volumes:
      - ./docker/keycloak/realms/:/opt/keycloak/data/import/
    depends_on:
      - keycloak-mysql
```

上述文件设置了 Keycloak 和 MySQL 数据库以存储 keycloak 配置。目前，我们正在使用通过 docker-compose 配置文件中的命令字段提供的'start-dev'参数在开发环境中启动 Keycloak。

现在你可以运行以下命令来启动 Keycloak Docker 容器：

```
docker compose up -d
```

## 密钥 cloak 配置

启动 Keycloak Docker 容器后，现在是时候设置 Keycloak 了，打开 URL [http://localhost:8181](http://localhost:8181/) ，这应该会打开 Keycloak 的主页，使用 admin/admin 作为凭据，因为我们已经在 docker-compose 文件中配置了它。

在 Keycloak 中，与特定应用程序（或）一组应用程序相关的所有客户端、用户和角色都位于一个称为域（Realm）的内部。域是相互独立的，因此如果您在一个域中创建了一个客户端/用户，则无法在另一个域中使用它。

在我们的项目中，我们将使用客户端凭据授权（Client Credentials grant），与 API 网关通信并获取访问令牌（Access Token），然后 API 网关将验证此访问令牌。

要开始，使用上述凭证登录 Keycloak 管理员页面，我们将要做的第一件事是创建域。

- 登录后，点击左上角带有“Keycloak”文本的下拉菜单，然后点击创建域按钮

- 提供域的名称（例如：spring-microservices-realm）并点击 **创建** 按钮
- 现在应该已成功创建领域
- 接下来，点击左侧边栏的 **客户端** 链接，然后点击 **创建客户端**
- 提供您喜欢的任何客户端 ID，例如：test-client-id，然后点击 **下一步**
- 将客户端身份验证设置为开启
- 在身份验证流程中，选择 **服务账户角色** 并取消选择所有其他选项，这确保我们的客户端支持客户端凭据授权
- 点击 **下一步** 然后点击 **保存**
- 最后，点击凭据选项卡，在这里您可以查看自动生成的客户端密钥，您还可以重新生成一个新的客户端密钥。请确保复制客户端密钥，我们将在后续部分使用它来请求访问 API 网关的令牌

## 配置 API 网关中的 Keycloak

现在让我们在我们的 API 网关应用程序中配置 Keycloak，为此我们需要将 \` **spring-security-oauth2-resource-server** \` 依赖项添加到我们的 pom.xml 文件中。

以下是添加依赖项后我们的 pom.xml 文件的样子。

**pom.xml**

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>3.2.4</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.programming.techie</groupId>
	<artifactId>api-gateway</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>api-gateway</name>
	<description>API Gateway</description>
	<properties>
		<java.version>21</java.version>
		<spring-cloud.version>2023.0.1</spring-cloud.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-gateway-mvc</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
		</dependency>
	</dependencies>
	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>${spring-cloud.version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>

	<build>
		<plugins>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
			</plugin>
		</plugins>
	</build>

</project>
```

现在让我们配置 application.properties 文件，并添加授权服务器的详细信息。为此，首先我们需要获取我们授权服务器的发行者 URI。对于 Keycloak，它通常是以下格式：  
`http://<key-cloak-url>/realm/<realm-name>`

对于我们在上一步创建的域，发行者 URI 将是：\[http://localhost:8181/realms/spring-microservices-realm\](http://localhost:8181/realms/spring-microservices-realm)

现在让我们继续在我们的 Spring Boot API 网关应用程序中配置它。

```
spring.security.oauth2.resourceserver.jwt.issuer-uri=http://localhost:8181/realms/spring-microservices-realm
```

下一步是创建安全配置类，让我们创建一个名为 config 的包，并在该包内创建一个名为 SecurityConfig.class 的类

```
package com.programming.techie.gateway.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
public class SecurityConfig {
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity httpSecurity) throws Exception {
        return httpSecurity.authorizeHttpRequests(authorize -> authorize
                        .anyRequest().authenticated())
                .oauth2ResourceServer(oauth2 -> oauth2.jwt(Customizer.withDefaults()))
                .build();
    }
}
```

这是基本的 安全配置，Spring Security 默认为我们创建，你也可以选择忽略添加此文件，如果你不需要添加任何额外的配置。

现在让我们运行 ApiGatewayApplication.java 类，并使用 Postman 测试我们的端点。

- 打开 Postman 客户端，在请求窗口中，点击授权标签，然后选择 OAuth2。
- 选择授权类型为客户端凭据
- 输入我们在上一步骤中创建的客户端的客户端 ID 和客户端密钥
- 其余字段保持不变，然后点击“获取新的访问令牌”按钮。
- 这将调用令牌端点并获取新的访问令牌。
- 点击“使用令牌”方法，将令牌添加到我们的请求上下文窗口中。
- 选择您想要发出的任何请求，例如：调用产品服务端点 - GET [HTTP://localhost:9000/api/product](http://localhost:9000/api/product) 并点击发送

您应该从 API 网关收到一个成功的响应。

在下一部分，我们将学习如何使用 Resilience4J 和 Spring Cloud Circuit Breaker 项目实现断路器模式。