在本 Spring Boot 微服务教程系列的第 7 部分中，我们将为项目设置一个 UI，我们将使用 Angular 作为前端框架。本教程包含构建 UI 的逻辑步骤。

我们将使用最新的 Angular 版本 - v18 - 来构建这个项目。在按照以下说明作之前，请确保您的机器上安装了 Node 和 Npm。

Node - [https://nodejs.org/en/download/package-manager](https://nodejs.org/en/download/package-manager) 下载链接

NPM - [https://docs.npmjs.com/downloading-and-installing-node-js-and-npm](https://docs.npmjs.com/downloading-and-installing-node-js-and-npm) 下载链接

Angular CLI - [https://angular.dev/tools/cli/setup-local#install-the-angular-cli](https://angular.dev/tools/cli/setup-local#install-the-angular-cli) 下载链接

## 创建 Angular 脚手架项目

首先，让我们使用以下命令创建一个新的 angular 项目：

```
ng new microservices-shop-frontend
```

Angular CLI 会问你一系列问题，我会提供项目相关设置的答案，其余设置，请根据自己的喜好随意选择。

- 您想使用哪种样式表格式？- **CSS**
- 是否要启用服务器端渲染 （SSR） 和静态站点生成 （SSG/Prerendering）？ **N**

回答完上述问题后，按 Enter，现在应该已成功创建项目。

创建项目后，您可以通过键入以下命令来启动基架应用程序：

```
ng serve
```

Angular CLI 现在将编译项目并启动 Web 服务器来为应用程序提供服务，它还将监视项目文件中的更改，以便每当代码发生更改时，Web 服务器都会自动重新加载并应用新的更改。

应用程序启动成功后，打开 URL - [http://localhost:4200](http://localhost:4200/)

现在您已经创建了 Angular 应用程序，现在是时候将 Tailwind CSS 配置为我们的 CSS 框架了。

## 安装 Tailwind CSS

我们将使用 [TailwindCSS](https://tailwindcss.com/) 作为我们的 CSS 框架，要将其安装在我们的 angular 项目中，请键入以下命令：

```
npm install -D tailwindcss postcss autoprefixer

npx tailwindcss init
```

执行完这两个命令后，会有一个 tailwind.config.js 文件，更新它的内容如下：

```
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./src/**/*.{html,ts}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
```

上面的配置会将 tailwind CSS 应用于我们项目中的所有 HTML 模板。

要启用 CSS，我们还必须使用以下代码更新 **src/styles.css** 文件：

```
@tailwind base;
@tailwind components;
@tailwind utilities;
```

完成此作后，再次运行 **ng serve** 命令以重新启动应用程序。

## 添加 Angular Auth OIDC 客户端依赖项

接下来我们要做的是在我们的项目中启用 OAuth2 功能，通过添加 [angular-auth-oidc-client](https://www.npmjs.com/package/angular-auth-oidc-client) 依赖项，通过执行以下命令：

```
npm install angular-auth-oidc-client
```

安装库后，我们需要通过创建一个名为 **src/app/config/auth-config.ts** 的文件来对其进行配置。

```
import { PassedInitialConfig } from 'angular-auth-oidc-client';

export const authConfig: PassedInitialConfig = {
  config: {
    authority: 'http://localhost:8181/realms/spring-microservices-security-realm',
    redirectUrl: window.location.origin,
    postLogoutRedirectUri: window.location.origin,
    clientId: 'angular-client',
    scope: 'openid profile offline_access',
    responseType: 'code',
    silentRenew: true,
    useRefreshToken: true,
    renewTimeBeforeTokenExpiresInSeconds: 30,
  }
}
```

上面的配置将设置我们的 angular 应用程序与 Keycloak 服务器通信，如果你想修改如何设置 Keycloak 服务器，请参考我之前的文章 - [https://programmingtechie.com/2024/04/18/spring-boot-microservices-tutorial-part-4/](https://programmingtechie.com/2024/04/18/spring-boot-microservices-tutorial-part-4/)

**authority** 字段指向我们在前面部分创建的 Realm 的 URL，然后客户端 ID 将是 **angular-client** ，也就是我们即将在 Keycloak 中创建的客户端 ID 的名称。

我们将使用 [Refresh Token](https://oauth.net/2/refresh-tokens/) 机制，在现有 Token 过期时获取新 Token。

## Create Header 组件

所以在下一步中，我们将添加 header 组件，要生成一个新组件，键入以下命令：

```
ng g c shared/header
```

上述命令在 **src/app/shared/header** 位置生成一个组件，如果你只提供 header 而不是 shared/header，那么组件将在 **src/app/header** 位置创建

**header.component.html**

```
<nav class="bg-white border border-gray-200 dark:border-gray-700 px-2 sm:px-4 py-2.5 rounded dark:bg-gray-800 shadow">
    <div class="container flex flex-wrap justify-between items-center mx-auto">
        <a href="/" class="flex items-center">
      <span class="self-center text-xl font-semibold whitespace-nowrap dark:text-white">
        Spring Boot Microservices Shop
      </span>
        </a>

        <div class="flex items-center">
            <button
                    id="menu-toggle"
                    type="button"
                    class="inline-flex items-center p-2 ml-3 text-sm text-gray-500 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600 md:hidden"
            >
                <span class="sr-only">Open main menu</span>
                <!-- Hamburger icon -->
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 6h16M4 12h16m-7 6h7"
                    />
                </svg>
            </button>
        </div>

        <div
                class="w-full md:block md:w-auto hidden"
                id="mobile-menu"
        >
            <ul class="flex flex-col mt-4 md:flex-row md:space-x-8 md:mt-0 md:text-sm md:font-medium">
                <li>
                    @if (isAuthenticated) {
                      <p class="text-white">Hi {{ username }}</p>
                      <a
                        (click)="logout()"
                        class="block py-2 pr-4 pl-3 text-gray-700 hover:bg-gray-50 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-gray-400 md:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">
                        Logout
                      </a>
                    } @else {
                      <a
                        (click)="login()"
                        class="block py-2 pr-4 pl-3 text-gray-700 hover:bg-gray-50 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-gray-400 md:dark:hover:text-white dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">
                        Login
                      </a>
                    }
                </li>
            </ul>
        </div>

    </div>
</nav>
```

**header.component.ts**

```
import {Component, inject, OnInit} from '@angular/core';
import {OidcSecurityService} from "angular-auth-oidc-client";

@Component({
  selector: 'app-header',
  standalone: true,
  imports: [],
  templateUrl: './header.component.html',
  styleUrl: './header.component.css'
})
export class HeaderComponent implements OnInit {

  private readonly oidcSecurityService = inject(OidcSecurityService);
  isAuthenticated = false;
  username = "";

  ngOnInit(): void {
    this.oidcSecurityService.isAuthenticated$.subscribe(
      ({isAuthenticated}) => {
        this.isAuthenticated = isAuthenticated;
      }
    )
    this.oidcSecurityService.userData$.subscribe(
      ({userData}) => {
        this.username = userData.preferred_username
      }
    )
  }

  login(): void {
    this.oidcSecurityService.authorize();
  }

  logout(): void {
    this.oidcSecurityService
      .logoff()
      .subscribe((result) => console.log(result));
  }
}
```

header 组件主要负责展示当前登录用户的信息（如用户名），然后提供应用程序的 Login/Logout 链接。在这里，我们使用 **angular-auth-oidc-client** 依赖项中的 **OidcSecurityService** 来实现登录和注销功能。

## 创建主页 组件

下一步是创建 Home Page 组件

**home-page.component.html**

```
<main>
  <div class="p-4">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold mb-4">Products ({{ products.length }})</h1>
      @if (isAuthenticated) {
        <button class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 ml-4"
                (click)="goToCreateProductPage()">
          Create Product
        </button>
      }
    </div>
    @if (products.length > 0) {
      @if (orderSuccess) {
        <h4 class="text-green-500 font-bold">Order Placed Successfully</h4>
      } @else if (orderFailed) {
        <h4 class="text-red-500 font-bold">Order Failed, please try again later</h4>
        @if(quantityIsNull) {
          <h4 class="text-red-500 font-bold">Quantity cannot be null</h4>
        }
      }
      <ul class="list-disc list-inside">
        @for (product of products; track product.id) {
          <li class="mb-2 p-4 bg-gray-100 rounded-lg shadow-sm flex justify-between items-center">
            <div>
              <span class="font-semibold">{{ product.name }}</span> -
              <span class="text-gray-600">
                Price: {{ product.price }}
              </span>
              <br/>
              <span >
                Quantity: <input type="number" #quantityInput/>
              </span>
              <br/>
            </div>
            <button class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 ml-4"
                    (click)="orderProduct(product, quantityInput.value)">
              Order Now
            </button>
          </li>
        }
      </ul>
    } @else if (products.length === 100) {
      <span class="text-sm text-gray-700">
      Click <a class="text-blue-500 hover:underline cursor-pointer">Load More</a> to see more products
    </span>
    } @else {
      <p class="text-red-500 font-semibold">No products found!</p>
    }
  </div>
</main>
```

**home-page.component.ts**

```
import {Component, inject, OnInit} from '@angular/core';
import {OidcSecurityService} from "angular-auth-oidc-client";
import {Product} from "../../model/product";
import {ProductService} from "../../services/product/product.service";
import {AsyncPipe, JsonPipe} from "@angular/common";
import {Router} from "@angular/router";
import {Order} from "../../model/order";
import {FormsModule} from "@angular/forms";
import {OrderService} from "../../services/order/order.service";

@Component({
  selector: 'app-homepage',
  templateUrl: './home-page.component.html',
  standalone: true,
  imports: [
    AsyncPipe,
    JsonPipe,
    FormsModule
  ],
  styleUrl: './home-page.component.css'
})
export class HomePageComponent implements OnInit {
  private readonly oidcSecurityService = inject(OidcSecurityService);
  private readonly productService = inject(ProductService);
  private readonly orderService = inject(OrderService);
  private readonly router = inject(Router);
  isAuthenticated = false;
  products: Array<Product> = [];
  quantityIsNull = false;
  orderSuccess = false;
  orderFailed = false;

  ngOnInit(): void {
    this.oidcSecurityService.isAuthenticated$.subscribe(
      ({isAuthenticated}) => {
        this.isAuthenticated = isAuthenticated;
        this.productService.getProducts()
          .pipe()
          .subscribe(product => {
            this.products = product;
          })
      }
    )
  }

  goToCreateProductPage() {
    this.router.navigateByUrl('/add-product');
  }

  orderProduct(product: Product, quantity: string) {

    this.oidcSecurityService.userData$.subscribe(result => {
      const userDetails = {
        email: result.userData.email,
        firstName: result.userData.firstName,
        lastName: result.userData.lastName
      };

      if(!quantity) {
        this.orderFailed = true;
        this.orderSuccess = false;
        this.quantityIsNull = true;
      } else {
        const order: Order = {
          skuCode: product.skuCode,
          price: product.price,
          quantity: Number(quantity),
          userDetails: userDetails
        }

        this.orderService.orderProduct(order).subscribe(() => {
          this.orderSuccess = true;
        }, error => {
          this.orderFailed = false;
        })
      }
    })
  }
}
```

首页将与 Order Service 交互，它负责对我们的微服务后端进行 HTTP 调用，要创建 Order Service，键入以下命令：

```
ng g s services/order
```

然后添加以下代码：

**order.service.ts**

```
import {Component, inject, OnInit} from '@angular/core';
import {OidcSecurityService} from "angular-auth-oidc-client";
import {Product} from "../../model/product";
import {ProductService} from "../../services/product/product.service";
import {AsyncPipe, JsonPipe} from "@angular/common";
import {Router} from "@angular/router";
import {Order} from "../../model/order";
import {FormsModule} from "@angular/forms";
import {OrderService} from "../../services/order/order.service";

@Component({
  selector: 'app-homepage',
  templateUrl: './home-page.component.html',
  standalone: true,
  imports: [
    AsyncPipe,
    JsonPipe,
    FormsModule
  ],
  styleUrl: './home-page.component.css'
})
export class HomePageComponent implements OnInit {
  private readonly oidcSecurityService = inject(OidcSecurityService);
  private readonly productService = inject(ProductService);
  private readonly orderService = inject(OrderService);
  private readonly router = inject(Router);
  isAuthenticated = false;
  products: Array<Product> = [];
  quantity = 1;
  orderSuccess = false;
  orderFailed = false;

  ngOnInit(): void {
    this.oidcSecurityService.isAuthenticated$.subscribe(
      ({isAuthenticated}) => {
        this.isAuthenticated = isAuthenticated;
        this.productService.getProducts()
          .pipe()
          .subscribe(product => {
            this.products = product;
          })
      }
    )
  }

  goToCreateProductPage() {
    this.router.navigateByUrl('/add-product');
  }

  orderProduct(product: Product, quantity: string) {

    this.oidcSecurityService.userData$.subscribe(result => {
      const userDetails = {
        email: result.userData.email,
        firstName: result.userData.firstName,
        lastName: result.userData.lastName
      };

      const order: Order = {
        skuCode: product.skuCode,
        price: product.price,
        quantity: Number(quantity),
        userDetails: userDetails
      }

      this.orderService.orderProduct(order).subscribe(() => {
        this.orderSuccess = true;
      }, error => {
        this.orderFailed = false;
      })
    })
  }
}
```

我们还需要创建模型类来传输有效负载，为此创建一个名为 model 的包和一个名为 **order.ts** 的文件

```
export interface Order {
  id?: number;
  orderNumber?: string;
  skuCode: string;
  price: number;
  quantity: number;
  userDetails: UserDetails
}

export interface UserDetails {
  email: string;
  firstName: string;
  lastName: string;
}
```

当我们从前端向后端进行调用时，我们必须确保我们的前端将每个 HTTP 请求的访问令牌发送到后端，为此，我们需要创建一个拦截器来拦截所有传出请求并添加令牌。

**拦截器/auth.interceptor.ts**

```
import {HttpInterceptorFn} from "@angular/common/http";
import {inject} from "@angular/core";
import {OidcSecurityService} from "angular-auth-oidc-client";

export const authInterceptor: HttpInterceptorFn = (req, next) => {
  const authService = inject(OidcSecurityService);

  authService.getAccessToken().subscribe(token => {
    if (token) {
      let header = 'Bearer ' + token;

      let headers = req.headers
        .set('Authorization', header);

      req = req.clone({headers});

      return next(req);
    }

    return next(req);
  })

  return next(req);

}
```

我们还从后端读取产品并将其显示在前端，为此我们还必须通过执行以下命令来创建类似于 order 服务的产品服务：

```
ng g s services/product
```

**product.service.ts**

```
import {Injectable} from '@angular/core';
import {HttpClient} from "@angular/common/http";
import {Observable} from "rxjs";
import {Product} from "../../model/product";

@Injectable({
  providedIn: 'root'
})
export class ProductService {

  constructor(private httpClient: HttpClient) {
  }

  getProducts(): Observable<Array<Product>> {
    return this.httpClient.get<Array<Product>>('http://localhost:9000/api/product');
  }

  createProduct(product: Product): Observable<Product> {
    return this.httpClient.post<Product>('http://localhost:9000/api/product', product);
  }
}
```

**型号/product.ts**

```
export interface Product {
  id?: string;
  skuCode: string;
  name: string;
  description: string;
  price: number;
}
```

## 创建 Add Product 组件

我们还需要创建一个组件来添加产品，为此请执行以下命令：

```
ng g c pages/add-product
```

**add-product.component.html**

```
<div class="container mx-auto p-4">
  <h2 class="text-2xl font-bold mb-4">Add Product</h2>
  @if (productCreated) {
    <h4 class="text-green-500">Product Created Successfully</h4>
  }
  <form [formGroup]="addProductForm" (ngSubmit)="onSubmit()">
    <div class="mb-4">
      <label class="block text-gray-700" for="skuCode">SKU Code</label>
      <input
        type="text"
        id="skuCode"
        formControlName="skuCode"
        class="border rounded w-full py-2 px-3 text-gray-700"
      />
      <div *ngIf="skuCode?.invalid && (skuCode?.dirty || skuCode?.touched)" class="text-red-500">
        <div *ngIf="skuCode?.errors?.['required']">SKU Code is required.</div>
        <div *ngIf="skuCode?.errors?.['minlength']">SKU Code must be at least 3 characters long.</div>
      </div>
    </div>

    <div class="mb-4">
      <label class="block text-gray-700" for="name">Name</label>
      <input
        type="text"
        id="name"
        formControlName="name"
        class="border rounded w-full py-2 px-3 text-gray-700"
      />
      <div *ngIf="name?.invalid && (name?.dirty || name?.touched)" class="text-red-500">
        <div *ngIf="name?.errors?.['required']">Name is required.</div>
        <div *ngIf="name?.errors?.['minlength']">Name must be at least 3 characters long.</div>
      </div>
    </div>

    <div class="mb-4">
      <label class="block text-gray-700" for="description">Description</label>
      <textarea
        id="description"
        formControlName="description"
        class="border rounded w-full py-2 px-3 text-gray-700"
      ></textarea>
      <div *ngIf="description?.invalid && (description?.dirty || description?.touched)" class="text-red-500">
        <div *ngIf="description?.errors?.['required']">Description is required.</div>
        <div *ngIf="description?.errors?.['minlength']">Description must be at least 10 characters long.</div>
      </div>
    </div>

    <div class="mb-4">
      <label class="block text-gray-700" for="price">Price</label>
      <input
        type="number"
        id="price"
        formControlName="price"
        class="border rounded w-full py-2 px-3 text-gray-700"
      />
      <div *ngIf="price?.invalid && (price?.dirty || price?.touched)" class="text-red-500">
        <div *ngIf="price?.errors?.['required']">Price is required.</div>
        <div *ngIf="price?.errors?.['min']">Price must be greater than 0.</div>
      </div>
    </div>

    <button
      type="submit"
      class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"
      [disabled]="addProductForm.invalid"
    >
      Add Product
    </button>
  </form>
</div>
```

**add-product.component.ts**

```
import {Component, inject} from '@angular/core';
import {FormBuilder, FormGroup, ReactiveFormsModule, Validators} from "@angular/forms";
import {Product} from "../../model/product";
import {ProductService} from "../../services/product/product.service";
import {NgIf} from "@angular/common";

@Component({
  selector: 'app-add-product',
  standalone: true,
  imports: [ReactiveFormsModule, NgIf],
  templateUrl: './add-product.component.html',
  styleUrl: './add-product.component.css'
})
export class AddProductComponent {
  addProductForm: FormGroup;
  private readonly productService = inject(ProductService);
  productCreated = false;

  constructor(private fb: FormBuilder) {
    this.addProductForm = this.fb.group({
      skuCode: ['', [Validators.required]],
      name: ['', [Validators.required]],
      description: ['', [Validators.required]],
      price: [0, [Validators.required]]
    })
  }

  onSubmit(): void {
    if (this.addProductForm.valid) {
      const product: Product = {
        skuCode: this.addProductForm.get('skuCode')?.value,
        name: this.addProductForm.get('name')?.value,
        description: this.addProductForm.get('description')?.value,
        price: this.addProductForm.get('price')?.value
      }
      this.productService.createProduct(product).subscribe(product => {
        this.productCreated = true;
        this.addProductForm.reset();
      })
    } else {
      console.log('Form is not valid');
    }
  }

  get skuCode() {
    return this.addProductForm.get('skuCode');
  }

  get name() {
    return this.addProductForm.get('name');
  }

  get description() {
    return this.addProductForm.get('description');
  }

  get price() {
    return this.addProductForm.get('price');
  }
}
```

## 配置路由

现在我们有几个组件，我们必须配置这些组件之间的路由，以打开 **app.routes.ts** 文件并添加以下内容：

```
import {Routes} from '@angular/router';
import {HomePageComponent} from "./pages/home-page/home-page.component";
import {AddProductComponent} from "./pages/add-product/add-product.component";

export const routes: Routes = [
  {path: '', component: HomePageComponent},
  {path: 'add-product', component: AddProductComponent}
];
```

现在让我们通过更新 **app.config.ts** 文件来添加一些最终的配置更改，以在我们的 angular 应用程序中启用 HTTP 客户端、OAuth2 和拦截器等功能：

```
import {ApplicationConfig, provideZoneChangeDetection} from '@angular/core';
import {provideRouter} from '@angular/router';

import {routes} from './app.routes';
import {provideHttpClient, withInterceptors} from "@angular/common/http";
import {authConfig} from "./config/auth.config";
import {provideAuth} from "angular-auth-oidc-client";
import {authInterceptor} from "./interceptor/auth.interceptor";

export const appConfig: ApplicationConfig = {
  providers: [provideZoneChangeDetection({eventCoalescing: true}),
    provideRouter(routes),
    provideHttpClient(withInterceptors([authInterceptor])),
    provideAuth(authConfig),
  ]
};
```

最后， **app.component.html** 文件如下所示：

```
<app-header></app-header>
<router-outlet />
```

## 在 Keycloak 中设置 Angular 客户端

在我们继续测试我们的应用程序之前，我们必须在 Keycloak 服务器中创建 Angular 客户端。为此，打开 localhost：8181 并使用您的管理员凭据登录到 Keycloak。

- 选择领域 - **spring-microservices-security-realm**
- 单击左侧菜单栏上的 **Client**
- 单击 **Create client** 按钮
- 输入客户端 ID 作为 **angular-client**
- 单击 **Next**
- 仅选择选项 - **Standard Flow** ，仅选中其他任何内容，取消选择默认启用的 **Direct access grants** 选项，我们的用例不需要它
- 单击 **Next**
- 在输入 **Valid redirect URI -** 提供值 - **[http://localhost:4200](http://localhost:4200/)**
- 在输入 **Web origins** - 提供值 - **\*** 以允许来自所有源的请求。
- 单击 **Save**

这就是在 Keycloak 中配置 Angular 客户端所需的全部内容，我们已经将 Angular 应用程序配置为使用我们刚刚创建的客户端。

## 启用 Keycloak 的用户注册

接下来我们要做的是使用户能够在 Keycloak 上自行注册，为此打开 Realm 设置，单击 Login，然后选择 User Registration 选项以启用它。

## 在 API Gateway 上启用 CORS

在我们继续测试我们的实施之前，我们必须在 API Gateway 上启用 CORS，因为我们的前端应用程序以 [http://localhost:4200](http://localhost:4200/) 运行，而我们的 API Gateway 以 [http://localhost:9000](http://localhost:9000/) 运行，因为它们是两个不同的源，浏览器不会允许对 API Gateway 的请求，只有当我们在 API Gateway 中明确允许源时，它才会允许。

要添加此配置，请在 API Gateway 项目的 SecurityConfig.java 类中使用以下配置。

```
package com.programming.techie.gateway.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.List;

@Configuration
public class SecurityConfig {

    private final String[] freeResourceUrls = {"/swagger-ui.html", "/swagger-ui/**", "/v3/api-docs/**",
            "/swagger-resources/**", "/api-docs/**", "/aggregate/**"};

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity httpSecurity) throws Exception {
        return httpSecurity.authorizeHttpRequests(authorize -> authorize
                        .requestMatchers(freeResourceUrls)
                        .permitAll()
                        .anyRequest().authenticated())
                .cors(cors -> cors.configurationSource(corsConfigurationSource()))
                .oauth2ResourceServer(oauth2 -> oauth2.jwt(Customizer.withDefaults()))
                .build();
    }

    @Bean
    CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.applyPermitDefaultValues();
        configuration.setAllowedMethods(List.of("GET", "POST", "PUT", "DELETE", "OPTIONS", "HEAD"));
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}
```

我们创建了一个名为 **corsConfigurationSource** 的 bean，在该 bean 中，我们允许任何 HTTP 方法，在生产级应用程序中，您不应该这样做，而是应该检查允许使用哪种 HTTP 方法，以及允许使用哪个 URL 访问您的服务。

## 测试应用程序

要测试应用程序，请打开 URL： **[http://localhost:4200](http://localhost:4200/)** ，您将看到如下所示的页面：

单击登录，您将被重定向到 Keycloak 登录页面。

在登录页面上，单击 Register （注册），提供必要的详细信息，然后提交。

您将自动登录到应用程序。

如果产品服务中没有任何产品，您可以通过单击提供必要信息的 添加产品 页面来创建一个产品，然后提交。

添加产品后，您可以在首页查看，如下所示：

您可以通过单击“ **立即订购** ”按钮订购产品，确保在单击“立即订购”按钮之前添加数量。

## 结论

我希望您从本教程中学到了一些东西，在下一个教程中，我们将继续我们的微服务系列，我们将了解如何在微服务项目中使用 Kafka 实现事件驱动架构。