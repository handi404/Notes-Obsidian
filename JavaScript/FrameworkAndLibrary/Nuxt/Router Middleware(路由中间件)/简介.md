### Nuxt 路由中间件（Middleware）详解

在 Nuxt 中，**中间件（Middleware）** 是在页面或路由渲染之前执行的一个函数。它用于处理身份验证、权限控制、日志记录、重定向等操作。Nuxt 提供了 **全局中间件** 和 **局部中间件**，你可以根据需求选择使用。

---

## 1. **创建中间件**

在 Nuxt 3 中，中间件通常存放在 `middleware/` 目录下。例如，创建一个 `auth.ts` 认证中间件：

```ts
export default defineNuxtRouteMiddleware((to, from) => {
  const user = useUser(); // 假设有一个 composable 管理用户状态
  if (!user.value) {
    return navigateTo('/login');
  }
});
```

- `defineNuxtRouteMiddleware` 是 Nuxt 3 提供的用于定义中间件的辅助函数。
- `to` 和 `from` 分别代表目标路由和来源路由。
- `navigateTo('/login')` 用于在未登录时跳转到登录页。

---

## 2. **全局中间件**

全局中间件会应用到所有页面。可以在 `middleware/` 目录下创建 `auth.global.ts` 文件：

```ts
export default defineNuxtRouteMiddleware((to, from) => {
  console.log(`全局中间件触发: ${from.fullPath} -> ${to.fullPath}`);
});
```

**注意：**

- 必须使用 `.global.ts` 命名，否则不会自动应用到所有路由。

---

## 3. **局部中间件**

### （1）页面级别

你可以在 `pages/` 目录下的某个 Vue 组件中使用 `definePageMeta` 来指定中间件：

```vue
<script setup lang="ts">
definePageMeta({
  middleware: 'auth'
});
</script>
```

如果有多个中间件，可以使用数组：

```vue
definePageMeta({
  middleware: ['auth', 'log']
});
```

### （2）路由导航守卫

如果你使用 `useRouter()` 进行路由跳转，你也可以在代码逻辑中手动调用中间件：

```ts
const router = useRouter();
router.beforeEach(authMiddleware);
```

---

## 4. **路由参数传递**

在中间件中，你可以访问 `to.query`、`to.params` 获取路由参数。例如：

```ts
export default defineNuxtRouteMiddleware((to) => {
  if (to.params.id === 'admin') {
    return navigateTo('/dashboard');
  }
});
```

---

## 5. **Nuxt 2 和 Nuxt 3 区别**

|特性|Nuxt 2|Nuxt 3|
|---|---|---|
|定义方式|`export default function (context) {}`|`export default defineNuxtRouteMiddleware((to, from) => {})`|
|目录结构|`middleware/`|`middleware/`|
|全局中间件|需在 `nuxt.config.js` 里注册|直接命名 `xxx.global.ts`|

---

## 6. **总结**

✅ **局部中间件** 适用于特定页面  
✅ **全局中间件** 适用于所有页面  
✅ **可用于身份验证、权限检查、日志记录等**

如果你想更好地管理 Nuxt 路由行为，中间件是一个非常强大的工具！🚀